{% extends 'inventory_app/base.html' %}

{% block title %}Mahsulotlar - Omborni Boshqarish Tizimi{% endblock %}

{% block extra_css %}
<style>
.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.search-result-item {
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background-color 0.2s ease;
}

.search-result-item:hover {
    background-color: #f8f9fa;
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-item.selected {
    background-color: #e3f2fd;
}

.search-result-image {
    width: 45px;
    height: 45px;
    border-radius: 6px;
    object-fit: cover;
    margin-right: 12px;
    border: 2px solid #e9ecef;
}

.search-result-placeholder {
    width: 45px;
    height: 45px;
    border-radius: 6px;
    background-color: #f8f9fa;
    margin-right: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #e9ecef;
}

.search-result-info {
    flex: 1;
}

.search-result-info h6 {
    margin: 0 0 4px 0;
    font-size: 0.95em;
    font-weight: 600;
    color: #333;
}

.search-result-info .details {
    font-size: 0.8em;
    color: #6c757d;
    margin-bottom: 2px;
}

.search-result-info .stock {
    font-size: 0.75em;
    font-weight: 500;
}

.stock-good { color: #28a745; }
.stock-low { color: #ffc107; }
.stock-critical { color: #dc3545; }
.stock-empty { color: #6c757d; }

.search-container {
    position: relative;
}

.loading-spinner {
    position: absolute;
    right: 45px;
    top: 50%;
    transform: translateY(-50%);
    display: none;
    color: #6c757d;
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}

.search-highlight {
    background-color: #fff3cd;
    padding: 1px 3px;
    border-radius: 3px;
    font-weight: 600;
}

.quick-actions {
    display: flex;
    gap: 5px;
    margin-top: 5px;
}

.quick-action-btn {
    padding: 2px 6px;
    font-size: 0.7em;
    border-radius: 3px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
}

.quick-action-btn:hover {
    background-color: #f8f9fa;
    border-color: #adb5bd;
}

.search-stats {
    padding: 8px 15px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.8em;
    color: #6c757d;
    font-weight: 500;
}

/* Filtered products styling */
.filtered-products {
    display: none;
}

.filtered-products.active {
    display: block;
}

.original-products {
    display: block;
}

.original-products.hidden {
    display: none;
}

.filter-info {
    background-color: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    display: none;
}

.filter-info.active {
    display: block;
}

.clear-search-btn {
    margin-left: 10px;
}

/* USB Scanner Styles */
.usb-scanner-section {
    background-color: #f8f9fa;
    border: 2px solid #28a745;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    position: relative;
}

.usb-scanner-input {
    width: 100%;
    padding: 10px;
    border: 2px solid #28a745;
    border-radius: 5px;
    font-size: 16px;
    background-color: white;
}

.usb-scanner-input:focus {
    outline: none;
    border-color: #20c997;
    box-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
}

.scanner-status {
    position: absolute;
    top: 10px;
    right: 15px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
}

.scanner-active {
    background-color: #28a745;
    color: white;
}

.scanner-inactive {
    background-color: #6c757d;
    color: white;
}

/* Filtered products table styling */
.filtered-products-table {
    margin-top: 20px;
}

.filtered-products-table .table {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.filtered-products-table .table thead th {
    background-color: #e9ecef;
    border-color: #dee2e6;
}

/* Cart Modal Improvements */
.cart-modal .quantity-input {
    border: 2px solid #28a745;
    border-radius: 8px;
    padding: 10px;
    font-size: 1.1em;
    font-weight: bold;
    text-align: center;
    background-color: #f8fff8;
}

.cart-modal .quantity-input:focus {
    outline: none;
    border-color: #20c997;
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.3);
}

.cart-modal .price-input {
    border: 2px solid #007bff;
    border-radius: 8px;
    padding: 10px;
    font-size: 1.1em;
    font-weight: bold;
    text-align: center;
    background-color: #f8f9ff;
}

.cart-modal .price-input:focus {
    outline: none;
    border-color: #0056b3;
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
}

.quantity-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}

.quantity-btn {
    width: 40px;
    height: 40px;
    border: 2px solid #28a745;
    background-color: #28a745;
    color: white;
    border-radius: 50%;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
}

.quantity-btn:hover {
    background-color: #218838;
    border-color: #1e7e34;
    transform: scale(1.1);
}

.quantity-btn:active {
    transform: scale(0.95);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Mahsulotlar</h1>
    <div>
        {% if user.is_staff %}
        <a href="{% url 'product_add' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i> Mahsulot Qo'shish
        </a>
        {% endif %}
        <a href="{% url 'cart_view' %}" class="btn btn-success" id="cart-button">
            <i class="fas fa-shopping-cart me-2"></i> Savat (<span id="cart-count">0</span>)
        </a>
    </div>
</div>

<!-- USB Scanner Section -->
<div class="usb-scanner-section">
    <div class="scanner-status scanner-inactive" id="scanner-status">
        <i class="fas fa-usb"></i> USB Skaner
    </div>
    <h5><i class="fas fa-qrcode me-2"></i> USB Skaner (Tez qo'shish)</h5>
    <p class="mb-2">USB skaner bilan QR kodni skanerlang yoki mahsulot ID sini kiriting:</p>
    <input type="text" id="usb-scanner-input" class="usb-scanner-input" 
           placeholder="QR kod yoki mahsulot ID ni kiriting va Enter bosing..." autofocus>
    <small class="text-muted">Masalan: 1, 2, 3 yoki to'liq QR kod URL</small>
</div>

<!-- Search and Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3" id="search-form">
            <div class="col-md-4">
                <label for="live-search" class="form-label">Mahsulot izlash</label>
                <div class="search-container">
                    <div class="input-group">
                        <input type="text" 
                               id="live-search" 
                               class="form-control" 
                               placeholder="Mahsulot nomi, tavsifi yoki kategoriya..." 
                               value="{{ request.GET.query|default:'' }}"
                               autocomplete="off">
                        <div class="loading-spinner" id="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <button class="btn btn-outline-secondary" type="button" id="clear-search" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="search-results" id="search-results"></div>
                    <input type="hidden" name="query" id="hidden-query" value="{{ request.GET.query|default:'' }}">
                </div>
            </div>
            <div class="col-md-4">
                <label for="{{ form.category.id_for_label }}" class="form-label">Kategoriya boʻyicha filtrlash</label>
                {{ form.category }}
            </div>
            <div class="col-md-4">
                <label class="form-label"> </label>
                <div class="d-grid d-flex">
                    <a href="{% url 'qr_scanner' %}" class="btn btn-success">
                        <i class="fas fa-qrcode"></i> Qr scanner
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-2"></i> Filtrlash
                    </button>
                </div>
            </div>
        </form>
        
        {% if request.GET.query or request.GET.category %}
        <div class="mt-3">
            <a href="{% url 'product_list' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-times me-2"></i> Filtrlarni tozalash
            </a>
            <span class="text-muted ms-2">
                {% if request.GET.query %}
                Qidiruv: "<strong>{{ request.GET.query }}</strong>"
                {% endif %}
                {% if request.GET.category %}
                Kategoriyada: "<strong>{{ form.category.value }}</strong>"
                {% endif %}
            </span>
        </div>
        {% endif %}
    </div>
</div>

<!-- Filter Info -->
<div class="filter-info" id="filter-info">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-filter me-2"></i>
            <strong>Filtrlangan natijalar:</strong> 
            <span id="filtered-count">0</span> ta mahsulot ko'rsatilmoqda
            <span class="text-muted">("<span id="search-term"></span>" bo'yicha)</span>
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="clearLiveSearch()">
            <i class="fas fa-times me-1"></i> Tozalash
        </button>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <span id="products-title">Barcha Mahsulotlar</span>
            {% if page_obj %}
            <span class="badge bg-secondary" id="total-count">{{ page_obj.paginator.count }} jami</span>
            {% endif %}
        </h5>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary btn-sm active" id="table-view-btn" onclick="toggleView('table')">
                <i class="fas fa-table"></i> Jadval
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="grid-view-btn" onclick="toggleView('grid')">
                <i class="fas fa-th"></i> To'r
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Original Products (from server) -->
        <div id="original-products" class="original-products">
            {% if page_obj %}
            
            <!-- Table View -->
            <div id="table-view-content">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Mahsulot</th> 
                                <th>Kategoriya</th> 
                                <th>Narx</th> 
                                <th>Zaxira</th> 
                                <th>Holat</th> 
                                <th>Harakatlar</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in page_obj %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            {% if product.image %}
                                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                                            {% else %}
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                <i class="fas fa-image text-muted"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h6 class="mb-0">
                                                <a href="{% url 'product_detail' product.id %}" class="text-decoration-none">
                                                    {{ product.name }}
                                                </a>
                                            </h6>
                                            {% if product.description %}
                                            <small class="text-muted">{{ product.description|truncatechars:50 }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-category">{{ product.category.name }}</span>
                                </td>
                                <td>
                                    <strong class="text-success">{{ product.sale_price }} so'm</strong>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="{% if product.stock <= 5 %}low-stock{% endif %}">
                                            {{ product.stock }} {% if product.unit_type == 'kg' %}kg{% else %}dona{% endif %}
                                        </span>
                                        {% if product.stock <= 5 %}
                                        <i class="fas fa-exclamation-triangle text-warning ms-2" title="Zaxira kam"></i>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if product.stock > 10 %} 
                                    <span class="badge bg-success">Stokda</span> 
                                    {% elif product.stock > 5 %} 
                                    <span class="badge bg-warning">Kam zaxira</span> 
                                    {% elif product.stock > 0 %} 
                                    <span class="badge bg-danger">Juda kam</span> 
                                    {% else %} 
                                    <span class="badge bg-dark">Tugagan</span> 
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'product_detail' product.id %}" class="btn btn-sm btn-outline-info" title="Batafsil">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'product_qr' product.id %}" class="btn btn-sm btn-outline-secondary" title="QR Kod">
                                            <i class="fas fa-qrcode"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="openCartModal({{ product.id }}, {{ product.min_sale_price }}, '{{ product.unit_type }}', {{ product.sale_price }}, {{ product.stock }})" title="Savatga qo'shish">
                                            <i class="fas fa-shopping-cart"></i>
                                        </button>
                                        {% if user.is_staff %}
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                            <ul class="dropdown-menu"> 
                                                <li><a class="dropdown-item" href="{% url 'product_edit' product.id %}"> 
                                                    <i class="fas fa-edit me-2"></i> Tahrirlash 
                                                </a></li> 
                                                <li><a class="dropdown-item" href="{% url 'stock_add' product.id %}"> 
                                                    <i class="fas fa-plus me-2"></i> Zaxira qo'shish 
                                                </a></li> 
                                                <li><a class="dropdown-item" href="#" onclick="openStockRemoveModal({{ product.id }}, {{ product.min_sale_price }})" {% if product.stock == 0 %}class="disabled"{% endif %}> 
                                                    <i class="fas fa-minus me-2"></i> Zaxira olib tashlash 
                                                </a></li> 
                                                <li><hr class="dropdown-divider"></li> 
                                                <li><a class="dropdown-item text-danger" href="#" 
                                                    data-bs-toggle="modal" data-bs-target="#deleteModal{{ product.id }}"> 
                                                    <i class="fas fa-trash me-2"></i> O'chirish 
                                                </a></li> 
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>

                            <!-- Delete Modal for each product -->
                            <div class="modal fade" id="deleteModal{{ product.id }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header"> 
                                            <h5 class="modal-title">O'chirishni tasdiqlash</h5> 
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button> 
                                        </div> 
                                        <div class="modal-body"> 
                                            Haqiqatan ham "<strong>{{ product.name }}</strong>"ni o'chirib tashlamoqchimisiz? 
                                            <div class="alert alert-warning mt-2"> 
                                                <small><strong>Ogohlantirish:</strong> Bu amalni bekor qilib bo'lmaydi va barcha tranzaksiya tarixini o'chiradi.</small> 
                                            </div> 
                                        </div> 
                                        <div class="modal-footer"> 
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button> 
                                            <a href="{% url 'product_delete' product.id %}" class="btn btn-danger">O'chirish</a> 
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Grid View -->
            <div id="grid-view-content" style="display: none;">
                <div class="row">
                    {% for product in page_obj %}
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="rounded" style="width: 80px; height: 80px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-light rounded p-3 d-inline-block">
                                        <i class="fas fa-image fa-2x text-muted"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <h6 class="card-title text-center">
                                    <a href="{% url 'product_detail' product.id %}" class="text-decoration-none">
                                        {{ product.name|truncatechars:20 }}
                                    </a>
                                </h6>
                                <div class="text-center mb-2">
                                    <span class="badge badge-category">{{ product.category.name }}</span>
                                </div>
                                <div class="text-center mb-2">
                                    <h5 class="text-success">Narx: {{ product.sale_price }} so'm</h5>
                                </div>
                                <div class="text-center mb-3">
                                    <span class="{% if product.stock <= 5 %}low-stock{% endif %}">
                                        {{ product.stock }} {% if product.unit_type == 'kg' %}kg{% else %}dona{% endif %}
                                    </span>
                                    {% if product.stock <= 5 %}
                                    <i class="fas fa-exclamation-triangle text-warning ms-1"></i>
                                    {% endif %}
                                </div>
                                <div class="d-grid gap-2">
                                    <a href="{% url 'product_detail' product.id %}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye me-2"></i> Batafsil
                                    </a>
                                    <div class="btn-group" role="group">
                                        {% if user.is_staff %}
                                        <a href="{% url 'stock_add' product.id %}" class="btn btn-success btn-sm">
                                            <i class="fas fa-plus"></i>
                                        </a>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="openStockRemoveModal({{ product.id }}, {{ product.min_sale_price }})" {% if product.stock == 0 %}disabled{% endif %}>
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        {% endif %}
                                        <a href="{% url 'product_qr' product.id %}" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-qrcode"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-success btn-sm" onclick="openCartModal({{ product.id }}, {{ product.min_sale_price }}, '{{ product.unit_type }}', {{ product.sale_price }}, {{ product.stock }})">
                                            <i class="fas fa-shopping-cart"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Mahsulotlar sahifalari" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.query %}query={{ request.GET.query }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}page=1">Birinchi</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.query %}query={{ request.GET.query }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}page={{ page_obj.previous_page_number }}">Oldingi</a>
                    </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.query %}query={{ request.GET.query }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.query %}query={{ request.GET.query }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}page={{ page_obj.next_page_number }}">Keyingi</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.query %}query={{ request.GET.query }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}page={{ page_obj.paginator.num_pages }}">Oxirgi</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            
            <div class="text-center text-muted">
                {{ page_obj.start_index }} dan {{ page_obj.end_index }} gacha, jami {{ page_obj.paginator.count }} mahsulot
            </div>
            {% endif %}

            {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <i class="fas fa-box-open fa-4x text-muted mb-4"></i>
                <h4 class="text-muted">Mahsulotlar topilmadi</h4>
                {% if request.GET.query or request.GET.category %}
                <p class="text-muted">Qidiruv mezonlari yoki filtrlaringizni o'zgartirib ko'ring.</p>
                <a href="{% url 'product_list' %}" class="btn btn-outline-primary">
                    <i class="fas fa-times me-2"></i> Filtrlarni tozalash
                </a>
                {% else %}
                <p class="text-muted">Omborga birinchi mahsulotni qo'shishdan boshlang.</p>
                <a href="{% url 'product_add' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i> Birinchi mahsulotni qo'shish
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Filtered Products (from live search) -->
        <div id="filtered-products" class="filtered-products">
            <!-- Table View -->
            <div id="filtered-table-view" class="filtered-products-table">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Mahsulot</th> 
                                <th>Kategoriya</th> 
                                <th>Narx</th> 
                                <th>Zaxira</th> 
                                <th>Holat</th> 
                                <th>Harakatlar</th>
                            </tr>
                        </thead>
                        <tbody id="filtered-products-tbody">
                            <!-- Filtrlangan mahsulotlar bu yerda ko'rsatiladi -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Grid View -->
            <div id="filtered-grid-view" style="display: none;">
                <div class="row" id="filtered-products-grid">
                    <!-- Filtrlangan mahsulotlar grid ko'rinishida bu yerda ko'rsatiladi -->
                </div>
            </div>
        </div>

        <!-- Stock Remove Modal -->
        <div class="modal fade" id="stockRemoveModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Zaxirani olib tashlash</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="stockRemoveForm">
                            <input type="hidden" id="productId">
                            <div class="mb-3">
                                <label for="soldPrice" class="form-label">Sotilgan narxi (so'm) *</label>
                                <input type="number" id="soldPrice" step="0.01" class="form-control" required>
                                <small class="text-muted">Minimal narx: <span id="minSalePrice"></span> so'mdan yuqori bo'lishi kerak</small>
                                <div id="soldPriceError" class="text-danger" style="display: none;"></div>
                            </div>
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Soni *</label>
                                <input type="number" id="quantity" min="0.01" step="0.01" class="form-control" required value="1">
                            </div>
                            <div class="mb-3">
                                <label for="notes" class="form-label">Eslatmalar</label>
                                <textarea id="notes" class="form-control" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                        <button type="button" class="btn btn-danger" onclick="quickStockUpdate()">Saqlash</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- YANGILANGAN: Add to Cart Modal -->
        <div class="modal fade cart-modal" id="cartModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Savatga qo'shish
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="cartForm">
                            {% csrf_token %}
                            <input type="hidden" id="cartProductId">
                            <input type="hidden" id="cartMinSalePrice">
                            <input type="hidden" id="cartMaxStock">
                            
                            <!-- Mahsulot ma'lumotlari -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title text-primary">Mahsulot ma'lumotlari:</h6>
                                            <div id="productInfo">
                                                <!-- Mahsulot ma'lumotlari bu yerda ko'rsatiladi -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Miqdor -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="cartQuantity" class="form-label">
                                        <i class="fas fa-balance-scale text-success me-2"></i>
                                        Miqdor (<span id="unitType"></span>) *
                                    </label>
                                    <div class="quantity-controls">
                                        <button type="button" class="quantity-btn" onclick="decreaseQuantity()">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="number" 
                                               id="cartQuantity" 
                                               class="form-control quantity-input" 
                                               min="0.01" 
                                               step="0.01" 
                                               required 
                                               value="1"
                                               style="width: 120px;">
                                        <button type="button" class="quantity-btn" onclick="increaseQuantity()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Mavjud: <span id="availableStock"></span></small>
                                    <div id="quantityError" class="text-danger" style="display: none;"></div>
                                </div>
                                
                                <!-- Narx -->
                                <div class="col-md-6">
                                    <label for="cartSoldPrice" class="form-label">
                                        <i class="fas fa-money-bill-wave text-primary me-2"></i>
                                        Sotilgan narxi (so'm) *
                                    </label>
                                    <input type="number" 
                                           id="cartSoldPrice" 
                                           class="form-control price-input" 
                                           step="500" 
                                           required>
                                    <small class="text-muted">Tavsiya etilgan: <span id="recommendedPrice"></span> so'm</small>
                                    <div id="cartSoldPriceError" class="text-danger" style="display: none;"></div>
                                </div>
                            </div>
                            
                            <!-- Jami summa -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <h5 class="card-title text-primary">
                                                <i class="fas fa-calculator me-2"></i>
                                                Jami summa
                                            </h5>
                                            <h3 class="text-success" id="totalAmount">0 so'm</h3>
                                            <small class="text-muted" id="calculation">0 × 0 = 0</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Bekor qilish
                        </button>
                        <button type="button" class="btn btn-success btn-lg" onclick="addToCart()">
                            <i class="fas fa-cart-plus me-2"></i>Savatga qo'shish
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- USB Scanner Result Modal -->
        <div class="modal fade" id="usbScannerModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Mahsulot topildi</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="usbScannerModalBody">
                        <!-- Mahsulot ma'lumotlari bu yerda ko'rsatiladi -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                        <button type="button" class="btn btn-success" id="usbAddToCart">Savatga qo'shish</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF token olish
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Global variables for search
let searchTimeout;
let currentSearchRequest;
let selectedSearchIndex = -1;
let searchResults = [];

// Cart count ni yangilash
function updateCartCount() {
    fetch('/api/cart/count/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('cart-count').textContent = data.count;
        }
    })
    .catch(error => {
        console.error('Cart count olishda xatolik:', error);
    });
}

// Sotilgan narxni tekshirish
function validateSoldPrice(soldPrice, minSalePrice, errorElementId) {
    const errorElement = document.getElementById(errorElementId);
    
    if (parseFloat(soldPrice) < parseFloat(minSalePrice)) {
        errorElement.textContent = `Bu narxda sotolmaysiz! Yuqoriroq narx kiriting.`;
        errorElement.style.display = 'block';
        return false;
    } else {
        errorElement.style.display = 'none';
        return true;
    }
}

// Miqdorni tekshirish
function validateQuantity(quantity, maxStock, errorElementId) {
    const errorElement = document.getElementById(errorElementId);
    
    if (parseFloat(quantity) > parseFloat(maxStock)) {
        errorElement.textContent = `Maksimal miqdor: ${maxStock}`;
        errorElement.style.display = 'block';
        return false;
    } else if (parseFloat(quantity) <= 0) {
        errorElement.textContent = `Miqdor 0 dan katta bo'lishi kerak`;
        errorElement.style.display = 'block';
        return false;
    } else {
        errorElement.style.display = 'none';
        return true;
    }
}

// Jami summani hisoblash
function calculateTotal() {
    const quantity = parseFloat(document.getElementById('cartQuantity').value) || 0;
    const price = parseFloat(document.getElementById('cartSoldPrice').value) || 0;
    const total = quantity * price;
    
    document.getElementById('totalAmount').textContent = total.toFixed(0) + ' so\'m';
    document.getElementById('calculation').textContent = `${quantity.toFixed(2)} × ${price.toFixed(0)} = ${total.toFixed(0)}`;
}

// Miqdorni kamaytirish
function decreaseQuantity() {
    const quantityInput = document.getElementById('cartQuantity');
    const currentValue = parseFloat(quantityInput.value) || 1;
    const step = parseFloat(quantityInput.step) || 0.01;
    const newValue = Math.max(step, currentValue - step);
    quantityInput.value = newValue.toFixed(2);
    calculateTotal();
}

// Miqdorni oshirish
function increaseQuantity() {
    const quantityInput = document.getElementById('cartQuantity');
    const maxStock = parseFloat(document.getElementById('cartMaxStock').value);
    const currentValue = parseFloat(quantityInput.value) || 0;
    const step = parseFloat(quantityInput.step) || 0.01;
    const newValue = Math.min(maxStock, currentValue + step);
    quantityInput.value = newValue.toFixed(2);
    calculateTotal();
}

// View toggle funksiyasi
function toggleView(viewType) {
    const tableView = document.getElementById('table-view-content');
    const gridView = document.getElementById('grid-view-content');
    const tableBtn = document.getElementById('table-view-btn');
    const gridBtn = document.getElementById('grid-view-btn');

    if (viewType === 'table') {
        tableView.style.display = 'block';
        gridView.style.display = 'none';
        tableBtn.classList.add('active');
        gridBtn.classList.remove('active');
        localStorage.setItem('productView', 'table');
    } else {
        tableView.style.display = 'none';
        gridView.style.display = 'block';
        tableBtn.classList.remove('active');
        gridBtn.classList.add('active');
        localStorage.setItem('productView', 'grid');
    }
    
    // Filtrlangan natijalar uchun ham ko'rinishni o'zgartirish
    toggleFilteredView(viewType);
}

// Filtrlangan natijalar uchun ko'rinishni o'zgartirish
function toggleFilteredView(viewType) {
    const filteredTableView = document.getElementById('filtered-table-view');
    const filteredGridView = document.getElementById('filtered-grid-view');
    
    if (viewType === 'table') {
        filteredTableView.style.display = 'block';
        filteredGridView.style.display = 'none';
    } else {
        filteredTableView.style.display = 'none';
        filteredGridView.style.display = 'block';
    }
}

// Live Search Functions
function performLiveSearch(query) {
    if (query.length < 1) {
        hideSearchResults();
        return;
    }
    
    if (currentSearchRequest) {
        currentSearchRequest.abort();
    }

    const loadingSpinner = document.getElementById('loading-spinner');
    
    loadingSpinner.style.display = 'block';

    // Natijalarni darhol ko'rsatish uchun
    showFilteredProductsDirectly(query);
    
    currentSearchRequest = new AbortController();
    
    fetch(`/api/products/?query=${encodeURIComponent(query)}`, {
        signal: currentSearchRequest.signal,
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingSpinner.style.display = 'none';
        searchResults = data.products || [];
        
        // Natijalarni ko'rsatish
        if (searchResults.length > 0) {
            showFilteredProducts(searchResults);
        }
        
        displaySearchResults(searchResults, query);
        selectedSearchIndex = -1;
    })
    .catch(error => {
        if (error.name !== 'AbortError') {
            console.error('Search error:', error);
            loadingSpinner.style.display = 'none';
        }
    });
}

// Natijalarni darhol ko'rsatish uchun yangi funksiya
function showFilteredProductsDirectly(query) {
    const originalProducts = document.getElementById('original-products');
    const filteredProducts = document.getElementById('filtered-products');
    const filterInfo = document.getElementById('filter-info');
    
    // Hide original products
    originalProducts.classList.add('hidden');
    
    // Show filter info
    filterInfo.classList.add('active');
    document.getElementById('search-term').textContent = query;
    
    // Show filtered products container
    filteredProducts.classList.add('active');
}

function displaySearchResults(products, query) {
    const searchResultsDiv = document.getElementById('search-results');
    
    if (products.length === 0) {
        searchResultsDiv.innerHTML = '<div class="no-results">Hech qanday mahsulot topilmadi</div>';
        searchResultsDiv.style.display = 'block';
        return;
    }

    let html = `<div class="search-stats">${products.length} ta mahsulot topildi</div>`;
    
    products.forEach((product, index) => {
        const stockClass = getStockClass(product.stock);
        const stockText = getStockText(product.stock);
        const imageUrl = product.image_url || '/static/inventory_app/img/no-image.png';
        
        // Highlight search term in product name
        const highlightedName = highlightSearchTerm(product.name, query);
        const highlightedDescription = highlightSearchTerm(product.description, query);
        
        html += `
            <div class="search-result-item" data-index="${index}" onclick="selectSearchResult(${index})">
                ${product.image_url ? 
                    `<img src="${imageUrl}" alt="${product.name}" class="search-result-image">` :
                    `<div class="search-result-placeholder"><i class="fas fa-image text-muted"></i></div>`
                }
                <div class="search-result-info">
                    <h6>${highlightedName}</h6>
                    <div class="details">${product.category} • ${product.sale_price} so'm</div>
                    ${highlightedDescription ? `<div class="details">${highlightedDescription}</div>` : ''}
                    <div class="stock ${stockClass}">Zaxira: ${product.stock} ${product.unit_type === 'kg' ? 'kg' : 'dona'} • ${stockText}</div>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="event.stopPropagation(); viewProductDetail(${product.id})">
                            <i class="fas fa-eye"></i> Ko'rish
                        </button>
                        <button class="quick-action-btn" onclick="event.stopPropagation(); openCartModal(${product.id}, ${product.min_sale_price}, '${product.unit_type}', ${product.sale_price}, ${product.stock})">
                            <i class="fas fa-shopping-cart"></i> Savatga
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    searchResultsDiv.innerHTML = html;
    searchResultsDiv.style.display = 'block';
}

function highlightSearchTerm(text, term) {
    if (!text || !term) return text;
    const regex = new RegExp(`(${term})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
}

function getStockClass(stock) {
    if (stock > 10) return 'stock-good';
    if (stock > 5) return 'stock-low';
    if (stock > 0) return 'stock-critical';
    return 'stock-empty';
}

function getStockText(stock) {
    if (stock > 10) return 'Stokda';
    if (stock > 5) return 'Kam zaxira';
    if (stock > 0) return 'Juda kam';
    return 'Tugagan';
}

function selectSearchResult(index) {
    if (searchResults[index]) {
        const product = searchResults[index];
        showFilteredProducts([product]);
        hideSearchResults();
    }
}

function showFilteredProducts(products) {
    const originalProducts = document.getElementById('original-products');
    const filteredProducts = document.getElementById('filtered-products');
    const filteredProductsTbody = document.getElementById('filtered-products-tbody');
    const filteredProductsGrid = document.getElementById('filtered-products-grid');
    const filterInfo = document.getElementById('filter-info');
    const searchTerm = document.getElementById('live-search').value;
    
    // Hide original products
    originalProducts.classList.add('hidden');
    
    // Show filter info
    filterInfo.classList.add('active');
    document.getElementById('filtered-count').textContent = products.length;
    document.getElementById('search-term').textContent = searchTerm;
    
    // Generate filtered products table HTML
    let tableHtml = '';
    let gridHtml = '';
    
    products.forEach(product => {
        const stockClass = getStockClass(product.stock);
        const stockBadge = getStockBadge(product.stock);
        const imageUrl = product.image_url || '/static/inventory_app/img/no-image.png';
        
        // Table row HTML
        tableHtml += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            ${product.image_url ? 
                                `<img src="${imageUrl}" alt="${product.name}" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">` :
                                `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>`
                            }
                        </div>
                        <div>
                            <h6 class="mb-0">
                                <a href="/products/${product.id}/" class="text-decoration-none">
                                    ${product.name}
                                </a>
                            </h6>
                            ${product.description ? `<small class="text-muted">${product.description.substring(0, 50)}${product.description.length > 50 ? '...' : ''}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge badge-category">${product.category}</span>
                </td>
                <td>
                    <strong class="text-success">${product.sale_price} so'm</strong>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <span class="${product.stock <= 5 ? 'low-stock' : ''}">
                            ${product.stock} ${product.unit_type === 'kg' ? 'kg' : 'dona'}
                        </span>
                        ${product.stock <= 5 ? '<i class="fas fa-exclamation-triangle text-warning ms-2" title="Zaxira kam"></i>' : ''}
                    </div>
                </td>
                <td>
                    ${stockBadge}
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <a href="/products/${product.id}/" class="btn btn-sm btn-outline-info" title="Batafsil">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="/products/${product.id}/qr/" class="btn btn-sm btn-outline-secondary" title="QR Kod">
                            <i class="fas fa-qrcode"></i>
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="openCartModal(${product.id}, ${product.min_sale_price}, '${product.unit_type}', ${product.sale_price}, ${product.stock})" title="Savatga qo'shish">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        
        // Grid item HTML
        gridHtml += `
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            ${product.image_url ? 
                                `<img src="${imageUrl}" alt="${product.name}" class="rounded" style="width: 80px; height: 80px; object-fit: cover;">` :
                                `<div class="bg-light rounded p-3 d-inline-block">
                                    <i class="fas fa-image fa-2x text-muted"></i>
                                </div>`
                            }
                        </div>
                        <h6 class="card-title text-center">
                            <a href="/products/${product.id}/" class="text-decoration-none">
                                ${product.name.length > 20 ? product.name.substring(0, 20) + '...' : product.name}
                            </a>
                        </h6>
                        <div class="text-center mb-2">
                            <span class="badge badge-category">${product.category}</span>
                        </div>
                        <div class="text-center mb-2">
                            <h5 class="text-success">Narx: ${product.sale_price} so'm</h5>
                        </div>
                        <div class="text-center mb-3">
                            <span class="${product.stock <= 5 ? 'low-stock' : ''}">
                                ${product.stock} ${product.unit_type === 'kg' ? 'kg' : 'dona'}
                            </span>
                            ${product.stock <= 5 ? '<i class="fas fa-exclamation-triangle text-warning ms-1"></i>' : ''}
                        </div>
                        <div class="d-grid gap-2">
                            <a href="/products/${product.id}/" class="btn btn-primary btn-sm">
                                <i class="fas fa-eye me-2"></i> Batafsil
                            </a>
                            <div class="btn-group" role="group">
                                <a href="/products/${product.id}/qr/" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-qrcode"></i>
                                </a>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="openCartModal(${product.id}, ${product.min_sale_price}, '${product.unit_type}', ${product.sale_price}, ${product.stock})">
                                    <i class="fas fa-shopping-cart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    filteredProductsTbody.innerHTML = tableHtml;
    filteredProductsGrid.innerHTML = gridHtml;
    filteredProducts.classList.add('active');
    
    // Joriy ko'rinishni saqlash
    const currentView = localStorage.getItem('productView') || 'table';
    toggleFilteredView(currentView);
}

function getStockBadge(stock) {
    if (stock > 10) return '<span class="badge bg-success">Stokda</span>';
    if (stock > 5) return '<span class="badge bg-warning">Kam zaxira</span>';
    if (stock > 0) return '<span class="badge bg-danger">Juda kam</span>';
    return '<span class="badge bg-dark">Tugagan</span>';
}

function hideSearchResults() {
    document.getElementById('search-results').style.display = 'none';
}

function clearLiveSearch() {
    const liveSearchInput = document.getElementById('live-search');
    const clearSearchBtn = document.getElementById('clear-search');
    const originalProducts = document.getElementById('original-products');
    const filteredProducts = document.getElementById('filtered-products');
    const filterInfo = document.getElementById('filter-info');
    
    liveSearchInput.value = '';
    clearSearchBtn.style.display = 'none';
    hideSearchResults();
    
    // Show original products
    originalProducts.classList.remove('hidden');
    filteredProducts.classList.remove('active');
    filterInfo.classList.remove('active');
    
    // Reset search results
    searchResults = [];
    
    liveSearchInput.focus();
}

function viewProductDetail(productId) {
    window.location.href = `/products/${productId}/`;
}

// USB Scanner funksiyalari
let currentScannedProduct = null;

function processUSBScannerInput(input) {
    const scannerStatus = document.getElementById('scanner-status');
    
    // QR kod formatini aniqlash va ID ni olish
    let productId = null;
    
    // URL formatidagi QR kodlarni tekshirish
    if (input.includes('/products/')) {
        const urlParts = input.split('/');
        for (let i = 0; i < urlParts.length; i++) {
            if (urlParts[i] === 'products' && i + 1 < urlParts.length) {
                productId = urlParts[i + 1].replace(/\D/g, ''); // Faqat raqamlarni olish
                break;
            }
        }
    } else {
        // Agar oddiy raqam bo'lsa
        productId = input.replace(/\D/g, '');
    }
    
    if (!productId) {
        alert('Noto\'g\'ri QR kod yoki mahsulot ID formati!');
        return;
    }
    
    // Scanner status ni active qilish
    scannerStatus.className = 'scanner-status scanner-active';
    scannerStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yuklanmoqda...';
    
    // Mahsulot ma'lumotlarini olish
    fetch(`/api/products/${productId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Mahsulot topilmadi');
            }
            return response.json();
        })
        .then(product => {
            currentScannedProduct = product;
            displayUSBScannerResult(product);
            scannerStatus.className = 'scanner-status scanner-active';
            scannerStatus.innerHTML = '<i class="fas fa-check"></i> Topildi!';
            
            // 2 soniyadan keyin inactive qilish
            setTimeout(() => {
                scannerStatus.className = 'scanner-status scanner-inactive';
                scannerStatus.innerHTML = '<i class="fas fa-usb"></i> USB Skaner';
            }, 2000);
        })
        .catch(error => {
            alert(`Xatolik: ${error.message}`);
            scannerStatus.className = 'scanner-status scanner-inactive';
            scannerStatus.innerHTML = '<i class="fas fa-usb"></i> USB Skaner';
        });
}

function displayUSBScannerResult(product) {
    const modalBody = document.getElementById('usbScannerModalBody');
    const imageUrl = product.image_url || '/static/inventory_app/img/no-image.png';
    
    modalBody.innerHTML = `
        <div class="d-flex align-items-center mb-3">
            <img src="${imageUrl}" alt="${product.name}" class="rounded me-3" style="width: 80px; height: 80px; object-fit: cover;">
            <div>
                <h5 class="mb-1">${product.name}</h5>
                <p class="mb-1 text-muted">${product.category}</p>
                <p class="mb-0"><strong>Tavsiya etilgan narx:</strong> ${product.sale_price} so'm</p>
                <p class="mb-0"><strong>Zaxira:</strong> ${product.stock} ${product.unit_type === 'piece' ? 'dona' : 'kg'}</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="usbQuantity" class="form-label">Miqdor</label>
                <input type="number" id="usbQuantity" class="form-control" value="1" min="0.01" step="0.01" max="${product.stock}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="usbSoldPrice" class="form-label">Sotilgan narxi (so'm)</label>
                <input type="number" id="usbSoldPrice" class="form-control" value="${product.sale_price}" min="0" step="500">
                <div id="usbPriceError" class="text-danger" style="display: none;"></div>
            </div>
        </div>
    `;
    
    // Narx validatsiyasi uchun event listener
    const priceInput = document.getElementById('usbSoldPrice');
    priceInput.addEventListener('input', function() {
        validateUSBPrice(this.value, product.min_sale_price);
    });
    
    // Modal ni ko'rsatish
    const modal = new bootstrap.Modal(document.getElementById('usbScannerModal'));
    modal.show();
}

function validateUSBPrice(price, minPrice) {
    const errorDiv = document.getElementById('usbPriceError');
    if (parseFloat(price) < parseFloat(minPrice)) {
        errorDiv.textContent = "Bu narxda sotolmaysiz! Yuqoriroq narx kiriting.";
        errorDiv.style.display = 'block';
        return false;
    } else {
        errorDiv.style.display = 'none';
        return true;
    }
}

function addUSBScannedToCart() {
    if (!currentScannedProduct) return;
    
    const quantity = parseFloat(document.getElementById('usbQuantity').value);
    const soldPrice = parseFloat(document.getElementById('usbSoldPrice').value);
    
    // Narxni tekshirish
    if (!validateUSBPrice(soldPrice, currentScannedProduct.min_sale_price)) {
        return;
    }
    
    // Savatga qo'shish
    fetch('/api/cart/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            product_id: currentScannedProduct.id,
            quantity: quantity,
            sold_price: soldPrice
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Mahsulot savatga qo\'shildi!');
            document.querySelector('#usbScannerModal .btn-close').click();
            updateCartCount();
            
            // USB input ni tozalash va focus qilish
            const usbInput = document.getElementById('usb-scanner-input');
            usbInput.value = '';
            usbInput.focus();
        } else {
            alert('Xatolik: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Xatolik:', error);
        alert('Savatga qo\'shishda xatolik yuz berdi.');
    });
}

// YANGILANGAN: openCartModal funksiyasi - stock parametri qo'shildi
function openCartModal(productId, minSalePrice, unitType, salePrice, stock) {
    console.log('openCartModal called with:', productId, minSalePrice, unitType, salePrice, stock); // Debug uchun
    
    // Mahsulot ma'lumotlarini saqlash
    document.getElementById('cartProductId').value = productId;
    document.getElementById('cartMinSalePrice').value = minSalePrice;
    document.getElementById('cartMaxStock').value = stock;
    
    // Mahsulot ma'lumotlarini ko'rsatish
    fetch(`/api/products/${productId}/`)
        .then(response => response.json())
        .then(product => {
            document.getElementById('productInfo').innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <img src="${product.image_url || '/static/inventory_app/img/no-image.png'}" 
                             alt="${product.name}" 
                             class="img-fluid rounded" 
                             style="max-height: 100px;">
                    </div>
                    <div class="col-md-8">
                        <h6 class="text-primary">${product.name}</h6>
                        <p class="mb-1"><strong>Kategoriya:</strong> ${product.category}</p>
                        <p class="mb-1"><strong>Tavsiya etilgan narx:</strong> ${product.sale_price} so'm</p>
                        <p class="mb-0"><strong>Mavjud zaxira:</strong> ${product.stock} ${product.unit_type === 'kg' ? 'kg' : 'dona'}</p>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Mahsulot ma\'lumotlarini olishda xatolik:', error);
        });
    
    // Form elementlarini to'ldirish
    document.getElementById('cartSoldPrice').value = salePrice; // Avtomatik to'ldirish
    document.getElementById('cartQuantity').value = '1';
    document.getElementById('unitType').innerText = unitType === 'kg' ? 'kg' : 'dona';
    document.getElementById('recommendedPrice').innerText = salePrice; // Tavsiya etilgan narxni ko'rsatish
    document.getElementById('availableStock').innerText = stock + ' ' + (unitType === 'kg' ? 'kg' : 'dona');
    document.getElementById('cartSoldPriceError').style.display = 'none';
    document.getElementById('quantityError').style.display = 'none';
    
    // Jami summani hisoblash
    calculateTotal();
    
    const modal = new bootstrap.Modal(document.getElementById('cartModal'));
    modal.show();
}

function addToCart() {
    const productId = document.getElementById('cartProductId').value;
    const soldPrice = parseFloat(document.getElementById('cartSoldPrice').value);
    const quantity = parseFloat(document.getElementById('cartQuantity').value);
    const minSalePrice = parseFloat(document.getElementById('cartMinSalePrice').value);
    const maxStock = parseFloat(document.getElementById('cartMaxStock').value);

    // Validatsiyalar
    if (!validateSoldPrice(soldPrice, minSalePrice, 'cartSoldPriceError')) {
        return;
    }
    
    if (!validateQuantity(quantity, maxStock, 'quantityError')) {
        return;
    }

    const url = `/api/cart/add/`;
    const data = {
        product_id: productId,
        quantity: quantity,
        sold_price: soldPrice
    };

    // Savatga qo'shish tugmasini disable qilish
    const addButton = document.querySelector('#cartModal .btn-success');
    addButton.disabled = true;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Qo\'shilmoqda...';

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Mahsulot savatga qo\'shildi!');
            document.querySelector('#cartModal .btn-close').click();
            updateCartCount();
        } else {
            alert('Xatolik: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Xatolik:', error);
        alert('Savatga qo\'shishda xatolik yuz berdi.');
    })
    .finally(() => {
        // Tugmani qayta faollashtirish
        addButton.disabled = false;
        addButton.innerHTML = '<i class="fas fa-cart-plus me-2"></i>Savatga qo\'shish';
    });
}

// Zaxirani kamaytirish modal
function openStockRemoveModal(productId, minSalePrice) {
    document.getElementById('productId').value = productId;
    document.getElementById('minSalePrice').textContent = minSalePrice;
    document.getElementById('soldPrice').value = '';
    document.getElementById('quantity').value = '1';
    document.getElementById('notes').value = '';
    document.getElementById('soldPriceError').style.display = 'none';
    new bootstrap.Modal(document.getElementById('stockRemoveModal')).show();
}

// Zaxirani kamaytirish funksiyasi
function quickStockUpdate() {
    const productId = document.getElementById('productId').value;
    const soldPrice = document.getElementById('soldPrice').value;
    const quantity = document.getElementById('quantity').value;
    const notes = document.getElementById('notes').value;
    const minSalePrice = document.getElementById('minSalePrice').textContent;

    if (!validateSoldPrice(soldPrice, minSalePrice, 'soldPriceError')) {
        return;
    }

    const url = `/api/stock/update/`;
    const data = {
        product_id: productId,
        quantity: quantity,
        transaction_type: 'OUT',
        sale_price: soldPrice,
        notes: notes || 'Tez zaxiradan chiqarish'
    };

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Zaxira muvaffaqiyatli kamaytirildi!');
            document.querySelector('#stockRemoveModal .btn-close').click();
            location.reload();
        } else {
            alert('Xatolik: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Xatolik:', error);
        alert('Zaxirani kamaytirishda xatolik yuz berdi.');
    });
}

// Document ready
document.addEventListener('DOMContentLoaded', function() {
    // Cart count ni yuklash
    updateCartCount();

    // View toggle
    const savedView = localStorage.getItem('productView') || 'table';
    toggleView(savedView);

    // Live search event listener
    const liveSearchInput = document.getElementById('live-search');
    const clearSearchBtn = document.getElementById('clear-search');

    liveSearchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length === 0) {
            clearLiveSearch();
            return;
        }
        
        // Show clear button
        clearSearchBtn.style.display = 'block';
        
        // Perform search immediately
        performLiveSearch(query);
    });

    // Keyboard navigation for search results
    liveSearchInput.addEventListener('keydown', function(e) {
        const searchResultsDiv = document.getElementById('search-results');
        const resultItems = searchResultsDiv.querySelectorAll('.search-result-item');
        
        if (resultItems.length === 0) return;
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedSearchIndex = Math.min(selectedSearchIndex + 1, resultItems.length - 1);
            updateSearchSelection(resultItems);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedSearchIndex = Math.max(selectedSearchIndex - 1, -1);
            updateSearchSelection(resultItems);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedSearchIndex >= 0 && selectedSearchIndex < resultItems.length) {
                selectSearchResult(selectedSearchIndex);
            }
        } else if (e.key === 'Escape') {
            hideSearchResults();
            selectedSearchIndex = -1;
        }
    });

    // Clear search button
    clearSearchBtn.addEventListener('click', clearLiveSearch);

    // Click outside to hide search results
    document.addEventListener('click', function(e) {
        const searchContainer = document.querySelector('.search-container');
        if (!searchContainer.contains(e.target)) {
            hideSearchResults();
        }
    });

    // USB Scanner input event listener
    const usbScannerInput = document.getElementById('usb-scanner-input');
    usbScannerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const input = this.value.trim();
            if (input) {
                processUSBScannerInput(input);
                this.value = '';
            }
        }
    });

    // USB Scanner modal add to cart button
    document.getElementById('usbAddToCart').addEventListener('click', addUSBScannedToCart);

    // Cart modal input event listeners
    document.getElementById('cartSoldPrice').addEventListener('input', function() {
        const minSalePrice = document.getElementById('cartMinSalePrice').value;
        validateSoldPrice(this.value, minSalePrice, 'cartSoldPriceError');
        calculateTotal();
    });
    
    document.getElementById('cartQuantity').addEventListener('input', function() {
        const maxStock = document.getElementById('cartMaxStock').value;
        validateQuantity(this.value, maxStock, 'quantityError');
        calculateTotal();
    });
    
    // Stock remove modal validation
    document.getElementById('soldPrice').addEventListener('input', function() {
        const minSalePrice = document.getElementById('minSalePrice').textContent;
        validateSoldPrice(this.value, minSalePrice, 'soldPriceError');
    });

    // USB input ga focus qilish
    usbScannerInput.focus();
    
    // Sahifa fokusga qaytganda USB inputga focus qilish
    window.addEventListener('focus', function() {
        usbScannerInput.focus();
    });
});

function updateSearchSelection(resultItems) {
    resultItems.forEach((item, index) => {
        if (index === selectedSearchIndex) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}
</script>
{% endblock %}
